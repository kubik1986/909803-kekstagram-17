"use strict";!function(){function o(e){window.utils.onEscPress(e,u)}function a(e){e.target.classList.contains("error__button")||u()}function i(){u()}var l=document.querySelector("main"),c=document.querySelector("#error").content.querySelector(".error"),n=document.querySelector("#success").content.querySelector(".success"),u=function(){l.querySelectorAll(".error, .success").forEach(function(e){e.remove()}),document.removeEventListener("keydown",o)};window.alerts={showError:function(e,t,i){var n=c.cloneNode(!0),r=n.querySelector(".error__button-try-again"),s=n.querySelector(".error__button-load-file");n.querySelector(".error__title").innerHTML=e,l.appendChild(n),n.focus(),n.addEventListener("click",a),document.addEventListener("keydown",o),null===t?r.remove():r.addEventListener("click",function(){u(),t()}),null===i?s.remove():s.addEventListener("click",function(){u(),i()})},showSuccess:function(e){var t=n.cloneNode(!0);t.querySelector(".success__title").innerHTML=e,l.appendChild(t),t.focus(),t.addEventListener("click",i),document.addEventListener("keydown",o)}}}(),function(){function r(e,t){var i=new XMLHttpRequest;return i.responseType="json",i.addEventListener("load",function(){200===i.status?e(i.response):t("Произошла ошибка. Статус ответа: "+i.status+" "+i.statusText)}),i.addEventListener("error",function(){t("Произошла ошибка соединения. Попробуйте повторить позднее.")}),i.addEventListener("timeout",function(){t("Время ожидания ответа сервера истекло.<br>Попробуйте повторить позднее.")}),i}var s="https://javascript.pages.academy/kekstagram";window.backend={load:function(e,t){var i=r(e,t);i.timeout=5e3,i.open("GET","https://javascript.pages.academy/kekstagram/data"),i.send()},save:function(e,t,i){var n=r(t,i);n.timeout=15e3,n.open("POST",s),n.send(e)}}}(),function(){function t(e,t){var i=t.comments.length-e.comments.length;return 0!==i?i:0!==(i=t.likes-e.likes)?i:e.url>t.url?1:e.url<t.url?-1:0}var i="filter-popular",n="filter-new",r="filter-discussed";window.data={pictures:[],filteredPictures:[],filter:function(e){switch(e){case i:this.filteredPictures=this.pictures;break;case n:this.filteredPictures=window.utils.shuffleArray(this.pictures).slice(0,12);break;case r:this.filteredPictures=this.pictures.slice().sort(t)}}}}(),function(){var n=0,r=100,s=.01,t={none:function(){return""},chrome:function(e){return"grayscale("+e/100+")"},sepia:function(e){return"sepia("+e/100+")"},marvin:function(e){return"invert("+e+"%)"},phobos:function(e){return"blur("+.03*e+"px)"},heat:function(e){return"brightness("+(.02*e+1)+")"}};window.Effects=function(e,t,i){this._element=e,this._radios=this._element.querySelectorAll(".effects__radio"),this._currentEffect="none",this._previewImg=t,this.slider=new window.Slider({sliderElement:i,scale:i.querySelector(".effect-level__line"),valueLine:i.querySelector(".effect-level__depth"),grip:i.querySelector(".effect-level__pin"),input:i.querySelector(".effect-level__value"),minValue:n,maxValue:r,valueStepByKeyPressMultiplier:s,cb:this.applyEffect.bind(this)}),this._init()},window.Effects.prototype={_init:function(){var t=this;t.reset(),t._radios.forEach(function(e){e.addEventListener("click",t._onRadioClick.bind(t))})},_clearPreviewImgClass:function(){this._previewImg.classList.contains("effects__preview--"+this._currentEffect)&&this._previewImg.classList.remove("effects__preview--"+this._currentEffect),0===this._previewImg.classList.length&&this._previewImg.removeAttribute("class")},_onRadioClick:function(e){var t=e.currentTarget.value;t!==this._currentEffect&&("none"===this._currentEffect?this.slider.show():"none"===t&&this.slider.hide(),this._clearPreviewImgClass(),"none"!==t&&this._previewImg.classList.add("effects__preview--"+t),this._currentEffect=t,this.slider.reset())},applyEffect:function(e){if(!t.hasOwnProperty(this._currentEffect))throw new Error('Функция для эффекта "'+this._currentEffect+'" не найдена');this._previewImg.style.filter=t[this._currentEffect](e)},reset:function(){this._clearPreviewImgClass(),this._element.querySelector("#effect-none").checked=!0,this._currentEffect="none",this.slider.hide(),this.slider.reset()}}}(),function(){function e(e){e.preventDefault();var t=e.target;t.classList.contains("img-filters__button")&&(function(e){e!==s&&(s.classList.remove("img-filters__button--active"),e.classList.add("img-filters__button--active"),s=e)}(t),window.utils.debounce(function(){s===o&&s!==r||(window.data.filter(s.id),window.gallery.updatePictures(window.data.filteredPictures),o=s)}))}var t="img-filters--inactive",i=document.querySelector(".img-filters"),n=i.querySelector(".img-filters__form"),r=n.querySelector("#filter-new"),s=n.querySelector(".img-filters__button--active"),o=s;window.filterForm={init:function(){n.addEventListener("click",e)},activate:function(){i.classList.remove(t)},deactivate:function(){i.classList.add(t)}}}(),function(){function t(){var i=document.createDocumentFragment();o.comments.slice(r,r+5).forEach(function(e){var t=function(e){var t=m.cloneNode(!0),i=t.querySelector("img");return i.src=e.avatar,i.alt=e.name,t.querySelector(".social__text").textContent=e.message,t}(e);i.appendChild(t),r++}),f.appendChild(i),r===s&&_.classList.add("hidden")}function i(){e.innerHTML=r+' из <span class="comments-count">'+s+"</span> комментариев"}function n(){c.classList.add("hidden"),l.classList.remove("modal-open"),a.focus(),_.removeEventListener("click",w),p.removeEventListener("click",g),document.removeEventListener("keydown",y)}var r,s,o,a,l=document.querySelector("body"),c=l.querySelector(".big-picture"),u=c.querySelector(".big-picture__img img"),d=c.querySelector(".social__caption"),h=c.querySelector(".likes-count"),e=c.querySelector(".social__comment-count"),f=c.querySelector(".social__comments"),_=c.querySelector(".social__comments-loader"),m=f.querySelector(".social__comment"),v=c.querySelector(".social__footer"),p=c.querySelector("#picture-cancel"),w=function(){t(),i()},g=function(){n()},y=function(e){window.utils.onEscPress(e,n)};window.fullscreenView={show:function(e){a=document.activeElement,o=window.data.filteredPictures[e],r=0,_.classList.contains("hidden")&&_.classList.remove("hidden"),u.src=o.url,d.textContent=o.description,h.textContent=o.likes,s=o.hasOwnProperty("comments")&&0!==o.comments.length?o.comments.length:0,f.innerHTML="",v.reset(),0<s?t():_.classList.add("hidden"),i(),c.classList.remove("hidden"),l.classList.add("modal-open"),c.focus(),c.scrollTop=0,_.addEventListener("click",w),p.addEventListener("click",g),document.addEventListener("keydown",y)}}}(),function(){function r(e){e.preventDefault(),window.fullscreenView.show(e.currentTarget.dataset.id)}var t=document.querySelector(".pictures.container"),s=[];window.gallery={renderPictures:function(e){var n=document.createDocumentFragment();e.forEach(function(e,t){var i=window.picture.create(t,e);n.appendChild(i),s.push(i),i.addEventListener("click",r)}),t.appendChild(n)},updatePictures:function(e){s.forEach(function(e){e.remove()}),s=[],this.renderPictures(e)}}}(),function(){var s=1024;window.ImageLoader=function(e){this._fileChooser=e.fileChooser,this._dropZone=e.dropZone,this._highlightClass=e.highlightClass,this._previewImg=e.previewImg,this._defaultImg=e.defaultImg,this._fileTypes=e.fileTypes,this._maxFileSize=e.maxFileSize,this._files=[],this._errors=[],this._onFileLoaded=e.onFileLoaded,this._init()},window.ImageLoader.prototype={_highlight:function(){this._dropZone.classList.contains(this._highlightClass)||this._dropZone.classList.add(this._highlightClass)},_unhighlight:function(){this._dropZone.classList.contains(this._highlightClass)&&this._dropZone.classList.remove(this._highlightClass)},_showError:function(e){var t=this;window.alerts.showError(e,null,function(){t._fileChooser.click()})},_validate:function(e){var t=!1,i="Допустимые типы файлов - "+this._fileTypes.join(", "),n="Максимальный размер файла - "+this._maxFileSize+"&nbsp;КБ",r=e.name.toLowerCase();return this._fileTypes.some(function(e){return r.endsWith(e)})?e.size>this._maxFileSize*s?this._errors.includes(n)||this._errors.push(n):t=!0:this._errors.includes(i)||this._errors.push(i),t},_clearFiles:function(){this._files=[]},_clearErrors:function(){this._errors=[]},_updatePreview:function(){var e=this;if(0<e._files.length){var t=new FileReader;t.addEventListener("load",function(){e._previewImg.src=t.result,e._onFileLoaded()}),t.readAsDataURL(e._files[0])}},_setDefaultPreview:function(){this._previewImg.src=this._defaultImg},_addFiles:function(e){if(this.reset(),e[0]&&this._validate(e[0])&&this._files.push(e[0]),0<this._errors.length){this._errors.unshift("Изображение не загружено");var t=this._errors.join(".<br>");this._showError(t)}},_setAcceptAttr:function(){this._fileChooser.accept="image/*"},_init:function(){var t=this;["dragenter","dragover","dragleave","drop"].forEach(function(e){t._dropZone.addEventListener(e,function(e){e.preventDefault(),e.stopPropagation()})}),["dragenter","dragover"].forEach(function(e){t._dropZone.addEventListener(e,function(){t._highlight()})}),["dragleave","drop"].forEach(function(e){t._dropZone.addEventListener(e,function(){t._unhighlight()})}),t._setAcceptAttr(),t._dropZone.addEventListener("drop",t._onDrop.bind(t)),t._fileChooser.addEventListener("change",t._onInputChange.bind(t))},_onDrop:function(e){var t=e.dataTransfer,i=Array.from(t.files);this._addFiles(i),this._updatePreview()},_onInputChange:function(){var e=Array.from(this._fileChooser.files);this._addFiles(e),this._updatePreview()},reset:function(){this._clearFiles(),this._fileChooser.value="",this._clearErrors(),this._setDefaultPreview()},getFiles:function(){return this._files}}}(),window.ImageScale=function(e){this._element=e.element,this._input=this._element.querySelector(".scale__control--value"),this._decreaseBtn=this._element.querySelector(".scale__control--smaller"),this._increaseBtn=this._element.querySelector(".scale__control--bigger"),this._minValue=parseInt(e.minValue,10),this._maxValue=parseInt(e.maxValue,10),this._defaultValue=parseInt(e.defaultValue,10),this._step=parseInt(e.step,10),this._value=parseInt(this._input.value,10),this._previewImg=e.previewImg,this._init()},window.ImageScale.prototype={_init:function(){this.reset(),this._input.setAttribute("value",this._defaultValue+"%"),this._element.addEventListener("click",this._onElementClick.bind(this))},_onElementClick:function(e){var t=e.target;t===this._decreaseBtn?this.setValue(this._value-this._step):t===this._increaseBtn&&this.setValue(this._value+this._step)},setValue:function(e){if(e=parseInt(e,10),!isNaN(e)){if(e<this._minValue)e=this._minValue;else if(e>this._maxValue)e=this._maxValue;else{var t=1/this._step;e=Math.round(e*t)/t}this._value=e,this._input.value=this._value+"%",this._previewImg.style.transform="scale("+this._value/100+")"}},reset:function(){this.setValue(this._defaultValue)}},function(){var n=document.querySelector("#picture").content.querySelector(".picture");window.picture={create:function(e,t){var i=n.cloneNode(!0);return i.dataset.id=e,i.querySelector(".picture__img").src=t.url,i.querySelector(".picture__comments").textContent=t.comments.length,i.querySelector(".picture__likes").textContent=t.likes,i}}}(),function(){var o=0,a=100;window.Slider=function(e){this._element=e.sliderElement,this._scale=e.scale,this._valueLine=e.valueLine,this._grip=e.grip,this._input=e.input,this._cb=e.cb,this._minValue=e.minValue,this._maxValue=e.maxValue,this._value=this._input.value,this._gripPosition=parseInt(getComputedStyle(this._grip).left,10),this._valueStepByKeyPress=e.valueStepByKeyPressMultiplier*(this._maxValue-this._minValue),this._init()},window.Slider.prototype={_moveGrip:function(e){this._grip.style.left=e+"%",this._valueLine.style.width=e+"%",this._gripPosition=e},_init:function(){this.reset(),this._grip.addEventListener("mousedown",this._onGripMousedown.bind(this)),this._grip.addEventListener("keydown",this._onGripKeyDown.bind(this))},_updateValue:function(e){this._moveGrip(e);var t=Math.round(e/100*(this._maxValue-this._minValue)+this._minValue);this._value=t,this._input.value=t,this._cb(this._value)},_onGripMousedown:function(e){e.preventDefault();var n=this,r=e.clientX,s=a/n._scale.offsetWidth;n._clientXCoordinateLimit={min:n._scale.getBoundingClientRect().left,max:n._scale.getBoundingClientRect().left+n._scale.offsetWidth};function t(e){e.preventDefault();var t=r-e.clientX;r=e.clientX;var i=Math.round(100*(n._gripPosition-t*s))/100;i<o?(i=o,r<n._clientXCoordinateLimit.min-pageXOffset&&(r=n._clientXCoordinateLimit.min-pageXOffset)):a<i&&(i=a,r>n._clientXCoordinateLimit.max-pageXOffset&&(r=n._clientXCoordinateLimit.max-pageXOffset)),n._updateValue(i)}var i=function(e){e.preventDefault(),document.removeEventListener("mousemove",t),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",t),document.addEventListener("mouseup",i)},_onGripKeyDown:function(e){e.keyCode===window.utils.KeyCode.RIGHT_ARROW?this.setValue(this._value+this._valueStepByKeyPress):e.keyCode===window.utils.KeyCode.LEFT_ARROW&&this.setValue(this._value-this._valueStepByKeyPress)},setValue:function(e){if(e=parseInt(e,10),!isNaN(e)){e<this._minValue?e=this._minValue:e>this._maxValue&&(e=this._maxValue),this._value=Math.round(e),this._input.value=this._value;var t=Math.round((this._value-this._minValue)/(this._maxValue-this._minValue)*100*100)/100;this._moveGrip(t),this._cb(this._value)}},getValue:function(){return this._value},reset:function(){this.setValue(this._maxValue)},hide:function(){this._element.classList.add("hidden")},show:function(){this._element.classList.remove("hidden")}}}(),function(){var e,t=document.querySelector("main"),i=document.querySelector("#messages").content.querySelector(".img-upload__message--loading");window.spinners={showLoadingMessage:function(){e=i.cloneNode(!0),t.appendChild(e),document.body.style.overflow="hidden"},hideLoadingMessage:function(){e&&e.remove(),document.body.style.overflow="visible"}}}(),function(){function e(){L.classList.add("modal-open"),S.classList.remove("hidden"),S.focus(),C.addEventListener("click",P),document.addEventListener("keydown",x)}function t(){S.classList.add("hidden"),L.classList.remove("modal-open"),u.reset(),d.reset(),h.reset(),V.value="",k.value="",C.removeEventListener("click",P),document.removeEventListener("keydown",x)}function i(){var e=V.value.trim();if(""===e)return V.setCustomValidity(""),!0;for(var t=e.split(/\s+/).map(function(e){return e.toLowerCase()}).sort(),i=0;i<t.length;i++){var n=t[i];if("#"!==n[0])return V.setCustomValidity("Хэш-тег должен начинаться с символа # (решётка)"),!1;if("#"===n)return V.setCustomValidity("Хэш-тег не может состоять только из одной решётки"),!1;if(-1!==n.indexOf("#",1))return V.setCustomValidity("Хэш-теги должны разделяться пробелами"),!1;if(i<t.length-1&&n===t[i+1])return V.setCustomValidity("Один и тот же хэш-тег не может быть использован дважды"),!1;if(n.length>g)return V.setCustomValidity("Максимальная длина одного хэш-тега "+g+" символов, включая решётку"),!1}return t.length>w?(V.setCustomValidity("Нельзя указать больше "+w+" хэш-тегов"),!1):(V.setCustomValidity(""),!0)}function n(){b.disabled=!0,window.spinners.showLoadingMessage(),window.backend.save(function(){var t=new FormData;I.forEach(function(e){("radio"!==e.type&&"checkbox"!==e.type||e.checked)&&t.append(e.name,e.value)});var e=u.getFiles();return 0<e.length&&t.append("filename",e[0],e[0].name),t}(),F,T)}function r(){document.removeEventListener("keydown",x)}function s(){document.addEventListener("keydown",x)}function o(){document.removeEventListener("keydown",x)}function a(){document.addEventListener("keydown",x)}function l(){i()}function c(){i()&&(function(){var e=V.value.trim();if(""!==e){var t=e.split(/\s+/);V.value=t.join(" ")}}(),n())}var u,d,h,f={FILE_TYPES:["jpg","jpeg","png"],MAX_FILE_SIZE:2048},_=25,m=100,v=25,p=100,w=5,g=20,y=140,L=document.querySelector("body"),E=document.querySelector(".img-upload__form"),S=E.querySelector(".img-upload__overlay"),C=S.querySelector("#upload-cancel"),q=E.querySelector(".img-upload__preview img"),V=E.querySelector(".text__hashtags"),k=E.querySelector(".text__description"),b=E.querySelector(".img-upload__submit"),I=E.querySelectorAll('input:not([type="file"]), textarea'),P=function(){t()},x=function(e){window.utils.onEscPress(e,t)},F=function(){window.spinners.hideLoadingMessage(),window.alerts.showSuccess("Изображение успешно загружено"),t(),b.disabled=!1},T=function(e){window.spinners.hideLoadingMessage(),window.alerts.showError("Ошибка загрузки файла.<br>"+e,n,null),b.disabled=!1};window.uploadForm={init:function(){u=new window.ImageLoader({fileChooser:E.querySelector("#upload-file"),dropZone:E.querySelector(".img-upload__control"),previewImg:q,highlightClass:"img-upload__control--highlighted",fileTypes:f.FILE_TYPES,maxFileSize:f.MAX_FILE_SIZE,defaultImg:"img/upload-default-image.jpg",onFileLoaded:e}),d=new window.ImageScale({element:E.querySelector(".img-upload__scale"),minValue:_,maxValue:m,step:v,defaultValue:p,previewImg:q}),h=new window.Effects(E.querySelector(".effects"),q,E.querySelector(".effect-level")),k.setAttribute("maxlength",y),k.addEventListener("focus",r),k.addEventListener("blur",s),V.addEventListener("focus",o),V.addEventListener("blur",a),V.addEventListener("change",l),b.addEventListener("click",c)}}}(),function(){var t,i={ESC:27,ENTER:13,LEFT_ARROW:37,RIGHT_ARROW:39};window.utils={KeyCode:i,shuffleArray:function(e){for(var t=e.slice(),i=t.length-1;0<i;i--){var n=Math.floor(Math.random()*(i+1)),r=t[n];t[n]=t[i],t[i]=r}return t},onEscPress:function(e,t){e.keyCode===i.ESC&&(e.preventDefault(),t())},debounce:function(e){t&&window.clearTimeout(t),t=window.setTimeout(e,500)}}}(),function(){function t(e){window.data.pictures=e,window.data.filteredPictures=e,window.filterForm.activate(),window.gallery.renderPictures(window.data.pictures)}var i=function(e){window.alerts.showError("Не удалось загрузить изображения других пользователей.<br>"+e,function(){window.backend.load(t,i)},null)};window.filterForm.deactivate(),window.filterForm.init(),window.uploadForm.init(),window.backend.load(t,i)}();